!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t=t||self).window=t.window||{})}(this,(function(t){"use strict";
/*! *****************************************************************************
    Copyright (c) Microsoft Corporation. All rights reserved.
    Licensed under the Apache License, Version 2.0 (the "License"); you may not use
    this file except in compliance with the License. You may obtain a copy of the
    License at http://www.apache.org/licenses/LICENSE-2.0

    THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
    KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
    WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
    MERCHANTABLITY OR NON-INFRINGEMENT.

    See the Apache Version 2.0 License for specific language governing permissions
    and limitations under the License.
    ***************************************************************************** */var e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,r)};var r=function(){return(r=Object.assign||function(t){for(var e,r=1,n=arguments.length;r<n;r++)for(var i in e=arguments[r])Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i]);return t}).apply(this,arguments)},n="0123456789bcdefghjkmnpqrstuvwxyz";function i(t,e){var r,n=e/110574,i=Math.min(90,t.latitude+n),o=Math.max(-90,t.latitude-n),u=2*Math.floor((r=e,Math.min(_(20003930/r),110))),a=2*Math.floor(y(e,i))-1,s=2*Math.floor(y(e,o))-1;return Math.min(u,a,s,110)}function o(t,e){j(t),j(e);var r=u(e.latitude-t.latitude),n=u(e.longitude-t.longitude),i=Math.sin(r/2)*Math.sin(r/2)+Math.cos(u(t.latitude))*Math.cos(u(e.latitude))*Math.sin(n/2)*Math.sin(n/2);return 6371*(2*Math.atan2(Math.sqrt(i),Math.sqrt(1-i)))}function u(t){if("number"!=typeof t||isNaN(t))throw new Error("Error: degrees must be a number");return t*Math.PI/180}function a(t,e){if(void 0===e&&(e=10),j(t),"number"!=typeof e||isNaN(e))throw new Error("precision must be a number");if(e<=0)throw new Error("precision must be greater than 0");if(e>22)throw new Error("precision cannot be greater than 22");if(Math.round(e)!==e)throw new Error("precision must be an integer");for(var r={min:-90,max:90},i={min:-180,max:180},o="",u=0,a=0,s=1;o.length<e;){var c=s?t.longitude:t.latitude,h=s?i:r,d=(h.min+h.max)/2;c>d?(u=1+(u<<1),h.min=d):(u=0+(u<<1),h.max=d),s=!s,a<4?a++:(a=0,o+=n[u],u=0)}return o}function s(t,e,n){j(t),v(e);var i=e.split("").reduce((function(t,e,n){var i;return r(r({},t),((i={})["g"+(n+1)]=e,i))}),{});return r(r({g:e},i),{l:t,d:n})}function c(t){var e=r({},t);return delete e.customKey,e}function h(t,e){if("[object Object]"===Object.prototype.toString.call(t)){var r=e?e.customKey:null,n="d"in t?t.d:t,i=f(n,r,e&&(e.merge||!!e.mergeFields));return i?s(i,a(i),n):{d:n}}throw new Error("document must be an object")}function d(t,e){if("[object Object]"===Object.prototype.toString.call(t)){var r={},n=f(t,e,!0);return n&&(r.l=n,r.g=a(r.l)),Object.getOwnPropertyNames(t).forEach((function(e){r["d."+e]=t[e]})),r}throw new Error("document must be an object")}function f(t,e,r){var n,i;if(void 0===r&&(r=!1),e)if(e in t)i=t[e];else{i=t;for(var o=0,u=e.split(".");o<u.length;o++){var a=u[o];if(!(a in i)){i=t.coordinates;break}i=i[a]}}else i=t.coordinates;if(i||(n="could not find GeoPoint"),i&&!j(i,!0)&&(n="invalid GeoPoint"),n&&!r)throw new Error("Invalid GeoFirestore document: "+n);return i}function l(t,e){var n=function(t,e){return g(t,!0)?{data:function(){return t.d},distance:e?o(t.l,e):null}:{data:function(){return t},distance:null}}(t.data(),e);return r({exists:t.exists,id:t.id},n)}function p(t,e){j(t);var r=Math.max(1,i(t,e)),o=Math.ceil(r/5),u=function(t,e){var r=e/110574,n=Math.min(90,t.latitude+r),i=Math.max(-90,t.latitude-r),o=m(e,n),u=m(e,i),a=Math.max(o,u);return[b(t.latitude,t.longitude),b(t.latitude,O(t.longitude-a)),b(t.latitude,O(t.longitude+a)),b(n,t.longitude),b(n,O(t.longitude-a)),b(n,O(t.longitude+a)),b(i,t.longitude),b(i,O(t.longitude-a)),b(i,O(t.longitude+a))]}(t,e).map((function(t){return function(t,e){v(t);var r=Math.ceil(e/5);if(t.length<r)return[t,t+"~"];var i=t.substring(0,r),o=i.substring(0,i.length-1),u=n.indexOf(i.charAt(i.length-1)),a=e-5*o.length,s=5-a,c=u>>s<<s,h=c+(1<<s);return h>31?[o+n[c],o+"~"]:[o+n[c],o+n[h]]}(a(t,o),r)}));return u.filter((function(t,e){return!u.some((function(r,n){return e>n&&t[0]===r[0]&&t[1]===r[1]}))}))}function _(t){return Math.log(t)/Math.log(2)}function y(t,e){var r=m(t,e);return Math.abs(r)>1e-6?Math.max(1,_(360/r)):1}function m(t,e){var r=u(e),n=6378137*Math.cos(r)*Math.PI/180*(1/Math.sqrt(1-.00669447819799*Math.sin(r)*Math.sin(r)));return n<1e-12?t>0?360:0:Math.min(360,t/n)}function b(t,e){var r={latitude:t,longitude:e};return j(r),r}function g(t,e){var r;if(void 0===e&&(e=!1),r=v(t.g,!0)?null:"invalid geohash on object",r=j(t.l,!0)?r:"invalid location on object",t&&"d"in t&&"object"==typeof t.d||(r="no valid document found"),r&&!e)throw new Error("Invalid GeoFirestore object: "+r);return!r}function v(t,e){var r;if(void 0===e&&(e=!1),"string"!=typeof t)r="geohash must be a string";else if(0===t.length)r="geohash cannot be the empty string";else for(var i=0,o=t;i<o.length;i++){var u=o[i];-1===n.indexOf(u)&&(r="geohash cannot contain '"+u+"'")}if(void 0===r||e)return!r;throw new Error("Invalid GeoFire geohash '"+t+"': "+r)}function w(t,e){var r;if(void 0===e&&(e=!1),"number"!=typeof t||isNaN(t)?r="limit must be a number":t<0&&(r="limit must be greater than or equal to 0"),void 0===r||e)return!r;throw new Error(r)}function j(t,e){var r;if(void 0===e&&(e=!1),t)if(void 0===t.latitude)r="latitude must exist on GeoPoint";else if(void 0===t.longitude)r="longitude must exist on GeoPoint";else{var n=t.latitude,i=t.longitude;"number"!=typeof n||isNaN(n)?r="latitude must be a number":n<-90||n>90?r="latitude must be within the range [-90, 90]":"number"!=typeof i||isNaN(i)?r="longitude must be a number":(i<-180||i>180)&&(r="longitude must be within the range [-180, 180]")}else r="GeoPoint must exist";if(void 0===r||e)return!r;throw new Error("Invalid location: "+r)}function q(t,e){if(void 0===e&&(e=!1),"object"!=typeof t)throw new Error("QueryCriteria must be an object");if(void 0===t.center&&void 0===t.radius)throw new Error("radius and/or center must be specified");if(e&&(void 0===t.center||void 0===t.radius))throw new Error("QueryCriteria for a new query must contain both a center and a radius");for(var r=0,n=Object.keys(t);r<n.length;r++){var i=n[r];if(!["center","radius","limit"].includes(i))throw new Error("Unexpected attribute '"+i+"' found in query criteria")}if(void 0!==t.center&&j(t.center),void 0!==t.radius){if("number"!=typeof t.radius||isNaN(t.radius))throw new Error("radius must be a number");if(t.radius<0)throw new Error("radius must be greater than or equal to 0")}void 0!==t.limit&&w(t.limit)}function O(t){if(t<=180&&t>=-180)return t;var e=t+180;return e>0?e%360-180:180- -e%360}var E=function(){function t(t){if(this._snapshot=t,"[object Object]"!==Object.prototype.toString.call(t))throw new Error("DocumentSnapshot must be an instance of a Firestore DocumentSnapshot");this._isWeb="[object Function]"===Object.prototype.toString.call(t.ref.firestore.enablePersistence)}return Object.defineProperty(t.prototype,"native",{get:function(){return this._snapshot},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"exists",{get:function(){return this._snapshot.exists},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"id",{get:function(){return this._snapshot.id},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"ref",{get:function(){return new M(this._snapshot.ref)},enumerable:!0,configurable:!0}),t.prototype.data=function(t){var e,r=this._isWeb&&t?this._snapshot.data(t):this._snapshot.data();return r?g(e=r,!0)?e.d:e:null},t.prototype.get=function(t,e){var r="d."+t;return this._isWeb&&e?this._snapshot.get(r,e):this._snapshot.get(r)},t.prototype.isEqual=function(e){return e instanceof t?this._snapshot.isEqual(e._snapshot):this._snapshot.isEqual(e)},t}(),x=function(){function t(t){if(this._writeBatch=t,"[object Object]"!==Object.prototype.toString.call(t))throw new Error("WriteBatch must be an instance of a Firestore WriteBatch")}return Object.defineProperty(t.prototype,"native",{get:function(){return this._writeBatch},enumerable:!0,configurable:!0}),t.prototype.set=function(t,e,r){var n=t instanceof M?t._document:t;return this._writeBatch.set(n,h(e,r),c(r)),this},t.prototype.update=function(t,e,r){var n=t instanceof M?t._document:t;return this._writeBatch.update(n,d(e,r)),this},t.prototype.delete=function(t){var e=t instanceof M?t._document:t;return this._writeBatch.delete(e),this},t.prototype.commit=function(){return this._writeBatch.commit()},t}(),P=function(){function t(t){if(this._firestore=t,"[object Object]"!==Object.prototype.toString.call(t))throw new Error("Firestore must be an instance of Firestore")}return Object.defineProperty(t.prototype,"native",{get:function(){return this._firestore},enumerable:!0,configurable:!0}),t.prototype.batch=function(){return new x(this._firestore.batch())},t.prototype.collection=function(t){return new G(this._firestore.collection(t))},t.prototype.runTransaction=function(t){return this._firestore.runTransaction(t)},t}(),M=function(){function t(t){if(this._document=t,"[object Object]"!==Object.prototype.toString.call(t))throw new Error("DocumentReference must be an instance of a Firestore DocumentReference");this._isWeb="[object Function]"===Object.prototype.toString.call(t.firestore.enablePersistence)}return Object.defineProperty(t.prototype,"native",{get:function(){return this._document},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"id",{get:function(){return this._document.id},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"firestore",{get:function(){return new P(this._document.firestore)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"onSnapshot",{get:function(){var t=this;return function(e,r){return t._document.onSnapshot((function(t){return e(new E(t))}),(function(t){r&&r(t)}))}},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"parent",{get:function(){return new G(this._document.parent)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"path",{get:function(){return this._document.path},enumerable:!0,configurable:!0}),t.prototype.collection=function(t){return new G(this._document.collection(t))},t.prototype.delete=function(){return this._document.delete().then((function(){return null}))},t.prototype.get=function(t){return void 0===t&&(t={source:"default"}),this._isWeb?this._document.get(t).then((function(t){return new E(t)})):this._document.get().then((function(t){return new E(t)}))},t.prototype.isEqual=function(e){return e instanceof t?this._document.isEqual(e._document):this._document.isEqual(e)},t.prototype.set=function(t,e){return this._document.set(h(t,e),c(e)).then((function(){return null}))},t.prototype.update=function(t,e){return this._document.update(d(t,e)).then((function(){return null}))},t}(),C=function(){function t(t,e){this._querySnapshot=t,this._center=e,e&&j(e),this._docs=t.docs.map((function(t){return l(t,e)}))}return Object.defineProperty(t.prototype,"native",{get:function(){return this._querySnapshot},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"docs",{get:function(){return this._docs},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"size",{get:function(){return this._docs.length},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"empty",{get:function(){return!this._docs.length},enumerable:!0,configurable:!0}),t.prototype.docChanges=function(){var t=this;return(Array.isArray(this._querySnapshot.docChanges)?this._querySnapshot.docChanges:this._querySnapshot.docChanges()).map((function(e){return{doc:l(e.doc,t._center),newIndex:e.newIndex,oldIndex:e.oldIndex,type:e.type}}))},t.prototype.forEach=function(t,e){this.docs.forEach(t,e)},t}(),S=function(){function t(t,e){var r=this;if(this._queryCriteria=e,this._docs=new Map,q(e),t.forEach((function(t){t.docs.forEach((function(t){var e=o(r._queryCriteria.center,t.data().l);r._queryCriteria.radius>=e&&r._docs.set(t.id,t)}))})),this._queryCriteria.limit&&this._docs.size>this._queryCriteria.limit)for(var n=Array.from(this._docs.values()).map((function(t){return{distance:o(r._queryCriteria.center,t.data().l),id:t.id}})).sort((function(t,e){return t.distance-e.distance})),i=this._queryCriteria.limit;i<n.length;i++)this._docs.delete(n[i].id)}return t.prototype.getGeoQuerySnapshot=function(){var t=Array.from(this._docs.values());return new C({docs:t,docChanges:function(){return t.map((function(t,e){return{doc:t,newIndex:e,oldIndex:-1,type:"added"}}))}},this._queryCriteria.center)},t}(),I=function(){function t(t,e,r,n){var i=this;this._queries=t,this._queryCriteria=e,this._onNext=r,this._onError=n,this._docs=new Map,this._firstRoundResolved=!1,this._firstEmitted=!1,this._newValues=!1,this._subscriptions=[],this._queriesResolved=[],q(e),this._queriesResolved=new Array(t.length).fill(0),t.forEach((function(t,e){var r=t.onSnapshot((function(t){return i._processSnapshot(t,e)}),(function(t){return i._error=t}));i._subscriptions.push(r)})),this._interval=setInterval((function(){return i._emit()}),100)}return t.prototype.unsubscribe=function(){var t=this;return function(){clearInterval(t._interval),t._subscriptions.forEach((function(t){return t()}))}},t.prototype._next=function(){var t=this;if(this._queryCriteria.limit&&this._docs.size>this._queryCriteria.limit)for(var e=Array.from(this._docs.values()).sort((function(t,e){return t.distance-e.distance})),n=this._queryCriteria.limit;n<e.length;n++)if(e[n].emitted){var i={change:r({},e[n].change),distance:e[n].distance,emitted:e[n].emitted};i.change.type="removed",this._docs.set(i.change.doc.id,i)}else this._docs.delete(e[n].change.doc.id);var o=0,u=Array.from(this._docs.values()).map((function(e,r){var n={type:e.change.type,doc:e.change.doc,oldIndex:e.emitted?e.change.newIndex:-1,newIndex:"removed"!==e.change.type?r-o:-1};return"removed"===n.type?(o--,t._docs.delete(n.doc.id)):t._docs.set(n.doc.id,{change:n,distance:e.distance,emitted:!0}),n})),a=u.reduce((function(e,r){return r.newIndex>=0?e.push(r.doc):t._docs.delete(r.doc.id),e}),[]);this._firstEmitted=!0,this._onNext(new C({docs:a,docChanges:function(){return u.reduce((function(t,e){return-1!==e.oldIndex&&"added"===e.type||t.push(e),t}),[])}},this._queryCriteria.center))},t.prototype._emit=function(){this._error?(this._onError&&this._onError(this._error),this.unsubscribe()()):this._newValues&&this._firstRoundResolved?(this._newValues=!1,this._next()):this._firstRoundResolved||(this._firstRoundResolved=this._queriesResolved.reduce((function(t,e){return t+e}),0)===this._queries.length)},t.prototype._processSnapshot=function(t,e){var r=this,n=Array.isArray(t.docChanges)?t.docChanges:t.docChanges();this._firstRoundResolved||(this._queriesResolved[e]=1),n.length?n.forEach((function(t){var e=t.doc.data().l?o(r._queryCriteria.center,t.doc.data().l):null,n=t.doc.id,i=r._docs.get(n),u={change:{doc:t.doc,oldIndex:i&&r._firstEmitted?i.change.oldIndex:-1,newIndex:i&&r._firstEmitted?i.change.newIndex:-1,type:i&&r._firstEmitted?t.type:"added"},distance:e,emitted:!!r._firstEmitted&&!!i};if(r._queryCriteria.radius>=e){if(!i&&"removed"===u.change.type)return;i||"modified"!==u.change.type||(u.change.type="added"),r._newValues=!0,r._docs.set(n,u)}else i?(u.change.type="removed",r._newValues=!0,r._docs.set(n,u)):i||r._firstRoundResolved||(r._newValues=!0)})):this._firstRoundResolved||(this._newValues=!0)},t}(),R=function(){function t(t,e){if(this._query=t,"[object Object]"!==Object.prototype.toString.call(t))throw new Error("Query must be an instance of a Firestore Query");this._isWeb="[object Function]"===Object.prototype.toString.call(t.firestore.enablePersistence),e&&(e.limit&&(this._limit=e.limit),e.center&&e.radius&&(q(e),this._center=e.center,this._radius=e.radius))}return Object.defineProperty(t.prototype,"native",{get:function(){return this._query},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"firestore",{get:function(){return new P(this._query.firestore)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"onSnapshot",{get:function(){var t=this;return function(e,r){return t._center&&t._radius?new I(t._generateQuery(),t._queryCriteria,e,r).unsubscribe():(t._limit?t._query.limit(t._limit):t._query).onSnapshot((function(t){return e(new C(t))}),r)}},enumerable:!0,configurable:!0}),t.prototype.get=function(t){var e=this;if(void 0===t&&(t={source:"default"}),this._center&&void 0!==this._radius){var r=this._generateQuery().map((function(r){return e._isWeb?r.get(t):r.get()}));return Promise.all(r).then((function(t){return new S(t,e._queryCriteria).getGeoQuerySnapshot()}))}var n=this._limit?this._query.limit(this._limit):this._query;return(this._isWeb?n.get(t):n.get()).then((function(t){return new C(t)}))},t.prototype.getWithCustomQueries=function(t,e){var r=this;if(void 0===e&&(e={source:"default"}),this._center&&void 0!==this._radius){var n=this._generateQueryWithGeohashes(),i=t?t(n):n,o=i.map((function(t){t[0];var n=t[1];return r._isWeb?n.get(e):n.get()}));return Promise.all(o).then((function(t){return t.map((function(t,e){return[i[e][0],new C(t)]}))}))}var u=this._limit?this._query.limit(this._limit):this._query;return(this._isWeb?u.get(e):u.get()).then((function(t){return[[null,new C(t)]]}))},t.prototype.limit=function(e){return w(e),this._limit=e,new t(this._query,this._queryCriteria)},t.prototype.near=function(e){return q(e),this._center=e.center||this._center,this._radius=e.radius||this._radius,new t(this._query,this._queryCriteria)},t.prototype.where=function(e,r,n){return new t(this._query.where(e?"d."+e:e,r,n),this._queryCriteria)},t.prototype._generateQueryWithGeohashes=function(){var t=this,e=p(this._center,1e3*this._radius).map(this._queryToString);return(e=(e=e.map((function(t){var e=t.split(":");return e[0].slice(0,e[0].length-1)}))).filter((function(t,r){return e.indexOf(t)===r}))).map((function(e){for(var r=t._query,n=0;n<e.length;n++)r=r.where("g"+(n+1),"==",e[n]);return[e,r]}))},t.prototype._generateQuery=function(){var t=this,e=p(this._center,1e3*this._radius).map(this._queryToString);return(e=e.filter((function(t,r){return e.indexOf(t)===r}))).map((function(e){var r=t._stringToQuery(e);return t._query.orderBy("g").startAt(r[0]).endAt(r[1])}))},Object.defineProperty(t.prototype,"_queryCriteria",{get:function(){return{center:this._center,limit:this._limit,radius:this._radius}},enumerable:!0,configurable:!0}),t.prototype._stringToQuery=function(t){var e=t.split(":");if(2!==e.length)throw new Error("Invalid internal state! Not a valid geohash query: "+t);return e},t.prototype._queryToString=function(t){if(2!==t.length)throw new Error("Not a valid geohash query: "+t);return t[0]+":"+t[1]},t}(),G=function(t){function r(e){var r=t.call(this,e)||this;return r._collection=e,r}return function(t,r){function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}(r,t),Object.defineProperty(r.prototype,"native",{get:function(){return this._collection},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"id",{get:function(){return this._collection.id},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"parent",{get:function(){return this._collection.parent?new M(this._collection.parent):null},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"path",{get:function(){return this._collection.path},enumerable:!0,configurable:!0}),r.prototype.add=function(t,e){if("[object Object]"===Object.prototype.toString.call(t)){var r=f(t,e),n=a(r);return this._collection.add(s(r,n,t)).then((function(t){return new M(t)}))}throw new Error("document must be an object")},r.prototype.doc=function(t){return new M(t?this._collection.doc(t):this._collection.doc())},r}(R),N=function(){function t(t){if(this._transaction=t,"[object Object]"!==Object.prototype.toString.call(t))throw new Error("Transaction must be an instance of a Firestore Transaction")}return Object.defineProperty(t.prototype,"native",{get:function(){return this._transaction},enumerable:!0,configurable:!0}),t.prototype.delete=function(t){var e=t instanceof M?t._document:t;return this._transaction.delete(e),this},t.prototype.get=function(t){var e=t instanceof M?t._document:t;return this._transaction.get(e).then((function(t){return new E(t)}))},t.prototype.set=function(t,e,r){var n=t instanceof M?t._document:t;return this._transaction.set(n,h(e,r),c(r)),this},t.prototype.update=function(t,e,r){var n=t instanceof M?t._document:t;return this._transaction.update(n,d(e,r)),this},t}();t.GeoCollectionReference=G,t.GeoDocumentReference=M,t.GeoDocumentSnapshot=E,t.GeoFirestore=P,t.GeoQuery=R,t.GeoQuerySnapshot=C,t.GeoTransaction=N,t.GeoWriteBatch=x,Object.defineProperty(t,"__esModule",{value:!0})}));
